<!DOCTYPE html>
<html lang="ar">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…Ø­Ù„Ø§Øª Ø£Ø¨Ùˆ Ø¹Ø¨ÙŠØ¯Ø© Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ù„Ø­ÙˆÙ…</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
  body{margin:0;font-family:'Cairo';direction:rtl;background:#1e272e;color:#fff}
  .wrap{max-width:900px;margin:20px auto;padding:16px;position:relative}
  .card{background:#2d3436;border-radius:16px;padding:20px}
  h1{color:#f6e58d;margin:0}
  .sub{color:#f9ca24;font-size:14px}
  input,button{font-family:'Cairo'}
  input{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #555;background:#444;color:#fff}
  .btn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;color:#fff;margin:4px}
  .ok{background:#00b894}
  .info{background:#0984e3}
  fieldset{border:1px dashed #888;border-radius:8px;padding:8px;margin-top:8px}
  .chip{padding:8px 12px;margin:4px;border-radius:20px;background:#555;cursor:pointer;display:inline-block}
  .chip.active{background:#f6e58d;color:#000}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:#3a3a3a}
  th,td{padding:8px;border-bottom:1px solid #555}
  th{background:#444}
  tfoot td{font-weight:bold;color:#f6e58d}
  .menu-btn{position:absolute;top:10px;left:10px;font-size:28px;cursor:pointer;}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.85);z-index:100}
  .modal.open{display:grid}
  .panel{background:#222;padding:20px;border-radius:12px;width:320px;text-align:center}
  .panel input{background:#333}

  /* Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ÙØµÙ„Ø© */
  #invoicePrint, #settlePrint{display:none;color:#000}
  #invoicePrint .receipt, #settlePrint .receipt{border:2px dashed #000;padding:16px;border-radius:10px;background:#fff}
  #invoicePrint h3, #settlePrint h3{margin:0 0 8px 0}

  @media print{
  body *{visibility:hidden !important}
  body.print-invoice #invoicePrint, body.print-settle #settlePrint{display:block !important}
  body.print-invoice #invoicePrint *, body.print-settle #settlePrint *{visibility:visible !important}

  /* Ø¬Ø¹Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„ÙŠÙ…ÙŠÙ† */
  #invoicePrint .receipt, #settlePrint .receipt{
    margin:0 !important;
    padding-top:0 !important;
    position:absolute;
    top:0;
    right:0;
    left:auto;
    direction:rtl;
    text-align:right;
  }
}

</style>
</head>
<body>
<div class="wrap">
  <div class="menu-btn" id="menuBtn">â˜°</div>
  <div class="card">
    <h1>Ù…Ø­Ù„Ø§Øª Ø£Ø¨Ùˆ Ø¹Ø¨ÙŠØ¯Ø© Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ù„Ø­ÙˆÙ…</h1>
    
    <div class="sub">Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¨Ùˆ Ø¹Ø¨ÙŠØ¯Ø© Ù‡Ø§ØªÙ â€“ 07718329962</div>
    <div class="sub">Ø¹Ø¨ÙŠØ¯Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²Ù† â€“ 07733229624</div>

    <input type="text" id="buyer" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ">
    <fieldset>
      <legend>Ø§Ù„Ù†ÙˆØ¹ </legend>
      <div class="chip" data-value="ØµØ¯Ø± Ø¬Ù„Ø¯">ØµØ¯Ø± Ø¬Ù„Ø¯</div>
      <div class="chip" data-value="ØµØ¯Ø± Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¯">ØµØ¯Ø± Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¯</div>
    </fieldset>
    <input type="number" id="price" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ">
    <input type="number" id="weight" step="0.01" placeholder="Ø§Ù„ÙˆØ²Ù† Ø¨Ø§Ù„ÙƒÙŠÙ„Ùˆ">
    <fieldset>
      <legend>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</legend>
      <div class="chip" data-value="Ù†Ù‚Ø¯Ù‹Ø§">Ù†Ù‚Ø¯Ù‹Ø§</div>
      <div class="chip" data-value="Ø¯ÙŠÙ†">Ø¯ÙŠÙ†</div>
    </fieldset>
    <button class="btn ok" id="add">Ø¥Ø¶Ø§ÙØ©</button>
    <button class="btn info" id="printInvoice">Ø·Ø¨Ø§Ø¹Ø©</button>

    <table id="tbl">
      <thead>
        <tr><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø³Ø¹Ø±/ÙƒØº</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø¯ÙØ¹</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="4">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</td><td id="grand">0.00</td><td></td></tr>
        <tr id="prevDebtRow" style="display:none"><td colspan="4">Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚</td><td id="prevDebt">0.00</td><td></td></tr>
        <tr id="totalWithDebtRow" style="display:none"><td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</td><td id="totalWithDebt">0.00</td><td></td></tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
<div class="modal" id="debtModal">
  <div class="panel">
    <h3>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚</h3>
    <input type="number" id="prevDebtInput" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚">
    <button class="btn ok" id="saveDebt">Ø­ÙØ¸</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (Ù…Ù† Ø§Ù„Ø«Ù„Ø§Ø« Ø´Ø®ÙˆØ·) -->
<div class="modal" id="menuModal">
  <div class="panel">
    <h3>ØªØ³Ø¯ÙŠØ¯</h3>
    <input type="text" id="buyerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ" />
    <input type="number" id="totalAmount" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" />
    <input type="number" id="paymentAmount" step="0.01" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯" />
    <div style="margin-top:10px">
      <button class="btn ok" id="saveBtn">Ø­ÙØ¸</button>
      <button class="btn info" id="printBtn">Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </div>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙ‚Ø· -->
<div id="invoicePrint">
  <div class="receipt">
    <div id="invoiceContent"></div>
  </div>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ ÙÙ‚Ø· -->
<div id="settlePrint">
  <div class="receipt">
    <div id="settleContent"></div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
const toNum=v=>parseFloat(v||0);
let sales=[],currentDebt=0,lastData={};

// Ù‚Ø§Ø¦Ù…Ø© Ø«Ù„Ø§Ø« Ø´Ø®ÙˆØ·
$('#menuBtn').onclick=()=>$('#menuModal').classList.add('open');
$('#saveBtn').onclick=()=>{
  const name=$('#buyerName').value.trim();
  const total=toNum($('#totalAmount').value);
  const pay=toNum($('#paymentAmount').value);
  if(!name||!total||!pay){alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„');return;}
  const remain=(total-pay).toFixed(2);
  lastData={buyer:name,total:total.toFixed(2),pay:pay.toFixed(2),remain};
  localStorage.setItem('lastPayment',JSON.stringify(lastData));
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
  $('#menuModal').classList.remove('open');
};
$('#printBtn').onclick=()=>{
  const data=JSON.parse(localStorage.getItem('lastPayment'))||lastData;
  if(!data.buyer){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');return;}
  $('#menuModal').classList.remove('open');
  $('#settleContent').innerHTML = `
    <h3>Ù…Ø­Ù„Ø§Øª Ø£Ø¨Ùˆ Ø¹Ø¨ÙŠØ¯Ø© Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ù„Ø­ÙˆÙ…</h3>
    <hr>
    <p>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ: <b>${data.buyer}</b></p>
    <p>Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯: <b>${data.total}</b></p>
    <p>Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯: <b>${data.pay}</b></p>
    <p>Ø§Ù„Ø¨Ø§Ù‚ÙŠ  : <b>${data.remain}</b></p>
  `;
  document.body.classList.add('print-settle');
  const cleanup=()=>{document.body.classList.remove('print-settle'); window.onafterprint=null;};
  window.onafterprint=cleanup; window.print();
};

function chipGroup(sel){const box=$(sel);let val='';box.addEventListener('click',e=>{
  const c=e.target.closest('.chip');if(!c)return;
  $$('fieldset .chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');val=c.dataset.value;
  if(val==='Ø¯ÙŠÙ†') $('#debtModal').classList.add('open');
});return{get:()=>val}};
const typeSel=chipGroup('fieldset:nth-of-type(1)');
const paySel=chipGroup('fieldset:nth-of-type(2)');

$('#saveDebt').onclick=()=>{
  currentDebt=toNum($('#prevDebtInput').value);
  $('#debtModal').classList.remove('open');
  renderTable();
};

$('#add').onclick=()=>{
  const b=$('#buyer').value.trim();
  const t=typeSel.get();
  const p=toNum($('#price').value);
  const w=toNum($('#weight').value);
  const pay=paySel.get();
  if(!b||!t||!p||!w||!pay){alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„');return;}
  const total=p*w;
  sales.push({buyer:b,type:t,price:p,weight:w,total,pay});
  renderTable();
};

function renderTable(){
  const body=$('#tbl tbody');body.innerHTML='';
  let grand=0;
  sales.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.buyer}</td><td>${s.type}</td><td>${s.price.toFixed(2)}</td><td>${s.weight.toFixed(2)}</td><td>${s.total.toFixed(2)}</td><td>${s.pay}</td>`;
    body.appendChild(tr); grand+=s.total;
  });
  $('#grand').textContent=grand.toFixed(2);
  if(currentDebt>0){
    $('#prevDebtRow').style.display='table-row';
    $('#totalWithDebtRow').style.display='table-row';
    $('#prevDebt').textContent=currentDebt.toFixed(2);
    $('#totalWithDebt').textContent=(grand+currentDebt).toFixed(2);
  }else{
    $('#prevDebtRow').style.display='none';
    $('#totalWithDebtRow').style.display='none';
  }
}

$('#printInvoice').onclick = () => {
  const b = $('#buyer').value.trim() || 'â€”';
  const g = toNum($('#grand').textContent);
  const rows = sales.map(s =>
    `<tr><td>${s.type}</td><td>${s.price.toFixed(2)}</td><td>${s.weight.toFixed(2)}</td><td>${s.pay}</td><td>${s.total.toFixed(2)}</td></tr>`
  ).join('');
  const debtHtml = currentDebt > 0
    ? `<p>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚: <b>${currentDebt.toFixed(2)}</b></p><p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯: <b>${(g + currentDebt).toFixed(2)}</b></p>`
    : '';

  // ğŸ‘‡ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø­ØªÙ‰ Ù„Ø§ ØªØ®ØªÙÙŠ ÙÙŠ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <title>ÙØ§ØªÙˆØ±Ø©</title>
      <style>
        body { font-family: 'Cairo', sans-serif; direction: rtl; padding: 15px; }
        h3 { text-align: center; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
        p { margin: 6px 0; }
      </style>
    </head>
    <body>
      <h3>Ù…Ø­Ù„Ø§Øª Ø£Ø¨Ùˆ Ø¹Ø¨ÙŠØ¯Ø© Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ù„Ø­ÙˆÙ…</h3>
      <div>Ù‡Ø§ØªÙ: 07718329962</div>
      <div>Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¨Ùˆ Ø¹Ø¨ÙŠØ¯Ø©</div>
      <div>Ø¹Ø¨ÙŠØ¯Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²Ù† â€“ 07733229624</div>
      <hr>
      <p>Ø§Ù„Ø²Ø¨ÙˆÙ†: <b>${b}</b></p>
      <table>
        <thead><tr><th>Ù†ÙˆØ¹ Ø§Ù„ØµØ¯Ø±</th><th>Ø§Ù„Ø³Ø¹Ø±/ÙƒØº</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <p>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${g.toFixed(2)}</b></p>
      ${debtHtml}
    </body></html>
  `);
  printWindow.document.close();
  setTimeout(() => {
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  }, 700);
};
</script>
</body>
</html>
